
import sys
import os
import torch
import numpy as np

# Add project root to path to access both workflows
root_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
sys.path.append(root_dir)
# Also add pinn-workflow specifically so 'import config' works inside train.py
sys.path.append(os.path.join(root_dir, 'pinn-workflow'))

# Import from pinn-workflow
import config as pinn_config # Now this works directly
import train as pinn_train

# Import from fea-workflow
# Need to add fea-workflow to path or rel import
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from solver.fem_solver import solve_fem
from postprocessing.visualization import plot_pinn_results, plot_comparison

def get_cfg_from_pinn_config():
    """Convert pinn-workflow config module variables to the dictionary required by FEM solver"""
    return {
        'geometry': {
            'Lx': pinn_config.Lx, 
            'Ly': pinn_config.Ly, 
            'H': pinn_config.H
        },
        'load_patch': {
            'x_start': 0.33, 'x_end': 0.67, # Assuming these were implicit/hardcoded in pinn setup, or we defaults
            'y_start': 0.33, 'y_end': 0.67,
            'pressure': pinn_config.p0
        },
        'material': {
            'E': pinn_config.E_vals[0], # Assuming uniform for now or layer 0
            'nu': pinn_config.nu_vals[0]
        },
        # These are just for the sampler if we needed it, but here we just need geometry for FEA
    }

def main():
    print("=== Phase 1: Training PINN via pinn-workflow ===")
    # Call the external training script
    # This will use pinn-workflow/config.py (100 EPOCHS LBFGS)
    pinn_model = pinn_train.train()
    
    print("\n=== Phase 2: Running FEA Benchmark ===")
    cfg = get_cfg_from_pinn_config()
    x, y, z, u_fea = solve_fem(cfg)
    
    print("\n=== Phase 3: Comparison ===")
    if torch.cuda.is_available():
        device = torch.device('cuda')
    elif torch.backends.mps.is_available():
        device = torch.device('mps')
    else:
        device = torch.device('cpu')
    
    # We need to wrap the config dict to look like what visualization expects?
    # visualization.py expects config['geometry']['Lx'] etc.
    # We constructed cfg exactly like that.
    
    plot_pinn_results(pinn_model, cfg, device, save_path=os.path.dirname(__file__))
    plot_comparison(u_fea, (x, y, z), pinn_model, cfg, device, save_path=os.path.dirname(__file__))
    
    print("Workflow Complete. Comparison plots generated.")

if __name__ == "__main__":
    main()
